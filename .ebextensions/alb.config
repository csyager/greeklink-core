####################################################################################################
#### Copyright 2016 Amazon.com, Inc. or its affiliates. All Rights Reserved.
####
#### Licensed under the Apache License, Version 2.0 (the "License"). You may not use this file
#### except in compliance with the License. A copy of the License is located at
####
####     http://aws.amazon.com/apache2.0/
####
#### or in the "license" file accompanying this file. This file is distributed on an "AS IS"
#### BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
#### License for the specific language governing permissions and limitations under the License.
####################################################################################################

####################################################################################################
#### This configuration file adds a listener to the Application Load Balancer for port 443, this new listener
#### requires the ARN of a public website certificate create residing in the certificate manager service.
#### The configuration file also modifies the default port 80 listener attached to an Application Load Balancer 
#### to automatically redirect incoming connections on HTTP to HTTPS.
#### This will not work with an environment using the load balancer type Classic or Network.
#### Do not use this configuration file if a listener has already been created for port 443 from the console.
####################################################################################################

Resources:
  AWSEBV2LoadBalancerListener:
    Type: 'AWS::ElasticLoadBalancingV2::Listener'
    Properties:
      DefaultActions:
        - Type: redirect
          RedirectConfig:
            Protocol: HTTPS
            Port: '443'
            Host: '#{host}'
            Path: '/#{path}'
            Query: '#{query}'
            StatusCode: HTTP_301
      LoadBalancerArn:
        Ref: AWSEBV2LoadBalancer
      Port: 80
      Protocol: HTTP
  AWSEBV2LoadBalancerListener443:
    Type: 'AWS::ElasticLoadBalancingV2::Listener'
    Properties:
      Certificates:
        - CertificateArn: arn:aws:acm:us-east-1:789527335953:certificate/3c2c3d7b-3183-4140-a8e8-6c4d95831c79
      DefaultActions:
        - Type: forward
          TargetGroupArn:
            Ref: AWSEBV2LoadBalancerTargetGroup
      LoadBalancerArn:
        Ref: AWSEBV2LoadBalancer
      Port: 443
      Protocol: HTTPS
  HealthCheckRule:
    Type: 'AWS::ElasticLoadBalancingV2::ListenerRule'
    Properties: 
      Actions: 
        - Type: forward
          TargetGroupArn:
            Ref: AWSEBV2LoadBalancerTargetGroup
      Conditions: 
        - Field: path-pattern
          PathPatternConfig:
            Values:
              - "/health"
              - "/health/"
      ListenerArn: 
        Ref: AWSEBV2LoadBalancerListener443
      Priority: 1
  WWWRedirectRule:
    Type: 'AWS::ElasticLoadBalancingV2::ListenerRule'
    Properties: 
      Actions: 
        - Type: redirect
          RedirectConfig:
            Host: "www.greek-rho.com"
            Path: "/#{path}"
            Query: "/#{query}"
            Port: "443"
            Protocol: "HTTPS"
            StatusCode: HTTP_301
      Conditions: 
        - Field: http-header
          HttpHeaderConfig:
            HttpHeaderName: Host
            Values:
              - greek-rho.com
      ListenerArn: 
        Ref: AWSEBV2LoadBalancerListener443
      Priority: 2 